version: '3.8'

services:
  urlshortner.restapi:
    container_name: urlshortner-prod-api
    # 1. Production Target: Targets the small, secure runtime image
    build:
      context: .
      dockerfile: src/UrlShortner.RestApi/Dockerfile
      target: final 
      
    # 2. Volumes Removed: Source code should be baked into the image, 
    # volumes are unnecessary and insecure in production.
    
    # 3. Secure Secret Injection & Environment
    environment:
      # Inject the connection string from the shell environment variable 
      # (retrieved from AWS Secrets Manager)
      - ConnectionStrings__TinyUrlDb=${DB_CONNECTION_STRING}
      - ASPNETCORE_ENVIRONMENT=Production # CRITICAL: Ensure production settings are used
      
    ports:
      # 4. Standard Port Mapping: Map standard HTTP port 80 to container port 8080
      - "80:8080"
      
    # 5. Stability: Ensure the container restarts if it crashes
    restart: always

# connectionstring to be managed externally (like AWS RDS).